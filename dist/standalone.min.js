!function(e){window.wysiwyg=e(window,document)}(function(e,t){"use strict";var n=function(e,t,n){var r;return function(){if(r){if(!n)return;clearTimeout(r)}var i=this,o=arguments;r=setTimeout(function(){r=null,e.apply(i,o)},t)}},r=function(t,n,r,i){t.addEventListener?t.addEventListener(n,r,i?!0:!1):t.attachEvent?t.attachEvent("on"+n,r):t!=e&&(t["on"+n]=r)},i=function(t,n,r,i){t.removeEventListener?t.removeEventListener(n,r,i?!0:!1):t.detachEvent?t.detachEvent("on"+n,r):t!=e&&(t["on"+n]=null)},o=function(e,n,r,i){if(t.createEvent){var o=t.createEvent("Event");o.initEvent(n,void 0!==r?r:!0,void 0!==i?i:!1),e.dispatchEvent(o)}else if(t.createEventObject){var o=t.createEventObject();e.fireEvent("on"+n,o)}else"function"==typeof e["on"+n]&&e["on"+n]()},a=function(e){return e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!1},l="undefined"!=typeof Node?Node.ELEMENT_NODE:1,s="undefined"!=typeof Node?Node.TEXT_NODE:3,u=function(e,t){for(var n=t;n;){if(n===e)return!0;n=n.parentNode}return!1},c=function(e,t){if(e.firstChild)return e.firstChild;for(;e;){if(e==t)return null;if(e.nextSibling)return e.nextSibling;e=e.parentNode}return null},f=function(n){if(e.getSelection){var r=e.getSelection();if(r.rangeCount>0)return r.getRangeAt(0)}else if(t.selection){var r=t.selection;return r.createRange()}return null},d=function(n,r){if(r)if(e.getSelection){var i=e.getSelection();i.removeAllRanges(),i.addRange(r)}else t.selection&&r.select()},p=function(){if(e.getSelection){var n=e.getSelection();if(!n.rangeCount)return!1;var r=n.getRangeAt(0).cloneRange();if(r.getBoundingClientRect){var i=r.getBoundingClientRect();if(i&&i.left&&i.top&&i.right&&i.bottom)return{left:parseInt(i.left),top:parseInt(i.top),width:parseInt(i.right-i.left),height:parseInt(i.bottom-i.top)};for(var o=r.getClientRects?r.getClientRects():[],a=0;a<o.length;++a){var i=o[a];if(i.left&&i.top&&i.right&&i.bottom)return{left:parseInt(i.left),top:parseInt(i.top),width:parseInt(i.right-i.left),height:parseInt(i.bottom-i.top)}}}}else if(t.selection){var n=t.selection;if("Control"!=n.type){var r=n.createRange();if(r.boundingLeft||r.boundingTop||r.boundingWidth||r.boundingHeight)return{left:r.boundingLeft,top:r.boundingTop,width:r.boundingWidth,height:r.boundingHeight}}}return!1},g=function(n){if(e.getSelection){var r=e.getSelection();return r.isCollapsed?!0:!1}if(t.selection){var r=t.selection;if("Text"==r.type){var i=t.selection.createRange(),o=t.body.createTextRange();return o.moveToElementText(n),o.setEndPoint("EndToStart",i),0==i.htmlText.length}if("Control"==r.type)return!1}return!0},h=function(n){if(e.getSelection){var r=e.getSelection();if(!r.rangeCount)return[];for(var i=[],o=0;o<r.rangeCount;++o)for(var a=r.getRangeAt(o),s=a.startContainer,f=a.endContainer;s;){if(s!=n){var d=!1;if(r.containsNode)d=r.containsNode(s,!0);else{var p=t.createRange();p.selectNodeContents(s);for(var o=0;o<r.rangeCount;++o){var a=r.getRangeAt(o);if(a.compareBoundaryPoints(a.END_TO_START,p)>=0&&a.compareBoundaryPoints(a.START_TO_END,p)<=0){d=!0;break}}}d&&i.push(s)}s=c(s,s==f?f:n)}return 0==i.length&&u(n,r.focusNode)&&r.focusNode!=n&&i.push(r.focusNode),i}if(t.selection){var r=t.selection;if("Text"==r.type){for(var i=[],g=r.createRangeCollection(),o=0;o<g.length;++o)for(var a=g[o],h=a.parentElement(),s=h;s;){var p=a.duplicate();if(p.moveToElementText(s.nodeType!=l?s.parentNode:s),p.compareEndPoints("EndToStart",a)>=0&&p.compareEndPoints("StartToEnd",a)<=0){for(var v=!1,y=0;y<i.length;++y)if(i[y]===s){v=!0;break}v||i.push(s)}s=c(s,h)}return 0==i.length&&u(n,t.activeElement)&&t.activeElement!=n&&i.push(t.activeElement),i}if("Control"==r.type){for(var i=[],a=r.createRange(),o=0;o<a.length;++o)i.push(a(o));return i}}return[]},v=function(){if(e.getSelection){var n=e.getSelection();if(!n.isCollapsed)try{n.collapseToEnd()}catch(r){}}else if(t.selection){var n=t.selection;if("Control"!=n.type){var i=n.createRange();i.collapse(!1),i.select()}}},y=function(n,r,i){if(e.getSelection){var o=e.getSelection();if(o.modify){for(var a=0;r>a;++a)o.modify("extend","backward","character");for(var a=0;i>a;++a)o.modify("extend","forward","character")}else{var l=o.getRangeAt(0);l.setStart(l.startContainer,l.startOffset-r),l.setEnd(l.endContainer,l.endOffset+i),o.removeAllRanges(),o.addRange(l)}}else if(t.selection){var o=t.selection;if("Control"!=o.type){var l=o.createRange();l.collapse(!0),l.moveStart("character",-r),l.moveEnd("character",i),l.select()}}},w=function(n){if(g(n))return null;if(e.getSelection){var r=e.getSelection();if(r.rangeCount){for(var i=t.createElement("div"),o=r.rangeCount,a=0;o>a;++a){var l=r.getRangeAt(a).cloneContents();i.appendChild(l)}return i.innerHTML}}else if(t.selection){var r=t.selection;if("Text"==r.type){var s=r.createRange();return s.htmlText}}return null},m=function(n,r){if(e.getSelection){var i=e.getSelection();if(u(n,i.anchorNode)&&u(n,i.focusNode))return!0;if(!r)return!1;var o=t.createRange();o.selectNodeContents(n),o.collapse(!1),i.removeAllRanges(),i.addRange(o)}else if(t.selection){var i=t.selection;if("Control"==i.type){var o=i.createRange();if(0!=o.length&&u(n,o(0)))return!0}else{var a=t.body.createTextRange();a.moveToElementText(n);var o=i.createRange();if(a.inRange(o))return!0}if(!r)return!1;var o=t.body.createTextRange();o.moveToElementText(n),o.setEndPoint("StartToEnd",o),o.select()}return!0},b=function(n,r){if(e.getSelection){var i=e.getSelection();if(i.getRangeAt&&i.rangeCount){var o=i.getRangeAt(0),a=t.createElement("div");a.innerHTML=r;for(var l,s,c=t.createDocumentFragment();l=a.firstChild;)s=c.appendChild(l);u(n,o.commonAncestorContainer)?(o.deleteContents(),o.insertNode(c)):n.appendChild(c),s&&(o=o.cloneRange(),o.setStartAfter(s),o.collapse(!0),i.removeAllRanges(),i.addRange(o))}}else if(t.selection){var i=t.selection;if("Control"!=i.type){var f=i.createRange();f.collapse(!0);var o=i.createRange();if(u(n,o.parentElement()))o.pasteHTML(r);else{var d=t.body.createTextRange();d.moveToElementText(n),d.collapse(!1),d.select(),d.pasteHTML(r)}o=i.createRange(),o.setEndPoint("StartToEnd",f),o.select()}}},C=function(C){C=C||{};var T=C.element||null;"string"==typeof T&&(T=t.getElementById(T));var E=C.onKeyDown||null,S=C.onKeyPress||null,L=C.onKeyUp||null,R=C.onSelection||null,k=C.onPlaceholder||null,x=C.onOpenpopup||null,P=C.onClosepopup||null,M=C.hijackContextmenu||!1,I=C.readOnly||!1,A="TEXTAREA"==T.nodeName||"INPUT"==T.nodeName;if(A){var N="contentEditable"in t.body;if(N){var H=navigator.userAgent.match(/(?:iPad|iPhone|Android).* AppleWebKit\/([^ ]+)/);H&&420<=parseInt(H[1])&&parseInt(H[1])<534&&(N=!1)}if(!N){var O=T,D=function(e){return e.replace(/<br[ \/]*>\n?/gi,"<br>\n")};O.value=D(O.value);var j=function(){return this},K=function(){return null};return{legacy:!0,getElement:function(){return O},getHTML:function(){return O.value},setHTML:function(e){return O.value=D(e),this},getSelectedHTML:K,sync:j,readOnly:function(e){return void 0===e?O.hasAttribute?O.hasAttribute("readonly"):!!O.getAttribute("readonly"):(e?O.setAttribute("readonly","readonly"):O.removeAttribute("readonly"),this)},collapseSelection:j,expandSelection:j,openPopup:K,closePopup:j,removeFormat:j,bold:j,italic:j,underline:j,strikethrough:j,forecolor:j,highlight:j,fontName:j,fontSize:j,subscript:j,superscript:j,align:j,format:j,indent:j,insertLink:j,insertImage:j,insertHTML:j,insertList:j}}}var O=null,B=null;if(A){O=T,O.style.display="none",B=t.createElement("DIV"),B.innerHTML=O.value;var F=O.parentNode,U=O.nextSibling;U?F.insertBefore(B,U):F.appendChild(B)}else B=T;I||B.setAttribute("contentEditable","true");var W=t.all&&!t.addEventListener?t:e,X=null;if(A){var Y=B.innerHTML;X=function(){var e=B.innerHTML;e!=Y&&(O.value=e,Y=e,o(O,"change",!1))}}var _;if(k){var V=!1;_=function(){for(var e=!0,t=B;t;)if(t=c(t,B)){if(t.nodeType==l){if("IMG"==t.nodeName){e=!1;break}}else if(t.nodeType==s){var n=t.nodeValue;if(n&&-1!=n.search(/[^\s]/)){e=!1;break}}}else;V!=e&&(k(e),V=e)},_()}var q=null,z=null,$=null;R&&(z=function(t,n,r){var i=g(B),o=h(B),a=null===t||null===n?null:{left:t,top:n,width:0,height:0},s=p();if(s&&(a=s),a){if(B.getBoundingClientRect){var u=B.getBoundingClientRect();a.left-=parseInt(u.left),a.top-=parseInt(u.top)}else{var c=B,f=0,d=0,v=!1;do f+=c.offsetLeft?parseInt(c.offsetLeft):0,d+=c.offsetTop?parseInt(c.offsetTop):0,"fixed"==c.style.position&&(v=!0);while(c=c.offsetParent);a.left-=f-(v?0:e.pageXOffset),a.top-=d-(v?0:e.pageYOffset)}a.left<0&&(a.left=0),a.top<0&&(a.top=0),a.width>B.offsetWidth&&(a.width=B.offsetWidth),a.height>B.offsetHeight&&(a.height=B.offsetHeight)}else if(o.length)for(var y=0;y<o.length;++y){var c=o[y];if(c.nodeType==l){a={left:c.offsetLeft,top:c.offsetTop,width:c.offsetWidth,height:c.offsetHeight};break}}R(i,a,o,r)},$=n(z,1));var G=null,Q=function(t){if(!t)var t=e.event;var n=t.target||t.srcElement;n.nodeType==s&&(n=n.parentNode),u(G,n)||Z()},J=function(){if(G)return G;r(W,"mousedown",Q,!0),G=t.createElement("DIV");var e=B.parentNode,n=B.nextSibling;return n?e.insertBefore(G,n):e.appendChild(G),x&&x(),G},Z=function(){G&&(G.parentNode.removeChild(G),G=null,i(W,"mousedown",Q,!0),P&&P())};r(B,"focus",function(){O&&o(O,"focus",!1)}),r(B,"blur",function(){X&&X(),O&&o(O,"blur",!1)});var ee=null;if(_||X){var te=X?n(X,250,!0):null,ne=function(e){_&&_(),te&&te()};ee=n(ne,1),r(B,"input",ee),r(B,"DOMNodeInserted",ee),r(B,"DOMNodeRemoved",ee),r(B,"DOMSubtreeModified",ee),r(B,"DOMCharacterDataModified",ee),r(B,"propertychange",ee),r(B,"textInput",ee),r(B,"paste",ee),r(B,"cut",ee),r(B,"drop",ee)}var re=function(t,n){if(!t)var t=e.event;var r=t.which||t.keyCode,i=String.fromCharCode(r||t.charCode),o=t.shiftKey||!1,l=t.altKey||!1,s=t.ctrlKey||!1,u=t.metaKey||!1;if(1==n){if(E&&E(r,i,o,l,s,u)===!1)return a(t)}else if(2==n){if(S&&S(r,i,o,l,s,u)===!1)return a(t)}else if(3==n&&L&&L(r,i,o,l,s,u)===!1)return a(t);if((2==n||3==n)&&(q=null,$&&$(null,null,!1)),2==n&&ee)switch(r){case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:break;default:ee()}};r(B,"keydown",function(e){return re(e,1)}),r(B,"keypress",function(e){return re(e,2)}),r(B,"keyup",function(e){return re(e,3)});var ie=function(t,n){if(!t)var t=e.event;var r=null,o=null;t.clientX&&t.clientY?(r=t.clientX,o=t.clientY):t.pageX&&t.pageY&&(r=t.pageX-e.pageXOffset,o=t.pageY-e.pageYOffset),t.which&&3==t.which?n=!0:t.button&&2==t.button&&(n=!0),i(W,"mouseup",ie),q=null,(M||!n)&&$&&$(r,o,n)};r(B,"mousedown",function(e){i(W,"mouseup",ie),r(W,"mouseup",ie)}),r(B,"mouseup",function(e){ie(e),ee&&ee()}),r(B,"dblclick",function(e){ie(e)}),r(B,"selectionchange",function(e){ie(e)}),M&&r(B,"contextmenu",function(e){return ie(e,!0),a(e)});var oe=function(n,r,i){if(d(B,q),!m(B,i))return!1;if(e.getSelection)try{return t.queryCommandSupported&&!t.queryCommandSupported(n)?!1:t.execCommand(n,!1,r)}catch(o){}else if(t.selection){var a=t.selection;if("None"!=a.type){var l=a.createRange();try{return l.queryCommandEnabled(n)?l.execCommand(n,!1,r):!1}catch(o){}}}return!1},ae=null,le=function(){(t.all||e.MSInputMethodContext)&&(ae=t.createElement("DIV"),B.appendChild(ae))},se=function(e){ae&&(B.removeChild(ae),ae=null),ee&&ee(),e?(v(),q=null):q&&(q=f(B))};return{getElement:function(){return B},getHTML:function(){return B.innerHTML},setHTML:function(e){return B.innerHTML=e,se(!0),this},getSelectedHTML:function(){return d(B,q),m(B)?w(B):null},sync:function(){return X&&X(),this},readOnly:function(e){return void 0===e?B.hasAttribute?!B.hasAttribute("contentEditable"):!B.getAttribute("contentEditable"):(e?B.removeAttribute("contentEditable"):B.setAttribute("contentEditable","true"),this)},collapseSelection:function(){return v(),q=null,this},expandSelection:function(e,t){return d(B,q),m(B)?(y(B,e,t),q=f(B),this):this},openPopup:function(){return q||(q=f(B)),J()},closePopup:function(){return Z(),this},removeFormat:function(){return oe("removeFormat"),oe("unlink"),se(),this},bold:function(){return oe("bold"),se(),this},italic:function(){return oe("italic"),se(),this},underline:function(){return oe("underline"),se(),this},strikethrough:function(){return oe("strikeThrough"),se(),this},forecolor:function(e){return oe("foreColor",e),se(),this},highlight:function(e){return oe("hiliteColor",e)||oe("backColor",e),se(),this},fontName:function(e){return oe("fontName",e),se(),this},fontSize:function(e){return oe("fontSize",e),se(),this},subscript:function(){return oe("subscript"),se(),this},superscript:function(){return oe("superscript"),se(),this},align:function(e){return le(),"left"==e?oe("justifyLeft"):"center"==e?oe("justifyCenter"):"right"==e?oe("justifyRight"):"justify"==e&&oe("justifyFull"),se(),this},format:function(e){return le(),oe("formatBlock",e),se(),this},indent:function(e){return le(),oe(e?"outdent":"indent"),se(),this},insertLink:function(e){return oe("createLink",e),se(!0),this},insertImage:function(e){return oe("insertImage",e,!0),se(!0),this},insertHTML:function(e){return oe("insertHTML",e,!0)||(d(B,q),m(B,!0),b(B,e)),se(!0),this},insertList:function(e){return le(),oe(e?"insertOrderedList":"insertUnorderedList"),se(),this}}};return C}),function(e){return e(window,document,jQuery)}(function(e,t,n){"use strict";var r=function(e,t,n){var r,i,o,a,l,s,u,c;switch(a=Math.floor(6*e),l=6*e-a,s=n*(1-t),u=n*(1-l*t),c=n*(1-(1-l)*t),a%6){case 0:r=n,i=c,o=s;break;case 1:r=u,i=n,o=s;break;case 2:r=s,i=n,o=c;break;case 3:r=s,i=u,o=n;break;case 4:r=c,i=s,o=n;break;case 5:r=n,i=s,o=u}var f=Math.floor(255*r).toString(16),d=Math.floor(255*i).toString(16),p=Math.floor(255*o).toString(16);return"#"+(f.length<2?"0":"")+f+(d.length<2?"0":"")+d+(p.length<2?"0":"")+p},i=function(e){return e.replace(/[&<>"]/g,function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};return t[e]||e})},o=function(o,a,l,s,u,c,f,d,p,g,h,v,y,w,m,b,C){var T=function(e,t){t&&(e.getSelectedHTML()?e.insertLink(t):e.insertHTML('<a href="'+i(t)+'">'+i(t)+"</a>")),e.closePopup().collapseSelection()},E=function(e,t){var r=x(c),i=n('<input type="text" value="'+(t?t.attr("href"):"")+'" />').addClass("wysiwyg-input").keypress(function(n){(10==n.which||13==n.which)&&(t?(t.attr("href",i.val()),e.closePopup().collapseSelection()):T(e,i.val()))});d&&i.attr("placeholder",d);var o=r.click(function(n){return t?(t.attr("href",i.val()),e.closePopup().collapseSelection()):T(e,i.val()),n.stopPropagation(),n.preventDefault(),!1}),a=n("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on");return a.append(i).append(o),a},S=function(t){var r=function(e,r){var o='<img id="wysiwyg-insert-image" src="" alt=""'+(r?' title="'+i(r)+'"':"")+" />";t.insertHTML(o).closePopup().collapseSelection();var a=n("#wysiwyg-insert-image").removeAttr("id");g&&a.css({maxWidth:g[0]+"px",maxHeight:g[1]+"px"}).load(function(){a.css({maxWidth:"",maxHeight:""});var e=a.width(),t=a.height();(e>g[0]||t>g[1])&&(e/t>g[0]/g[1]?(t=parseInt(t/e*g[0]),e=g[0]):(e=parseInt(e/t*g[1]),t=g[1]),a.attr("width",e).attr("height",t))}),a.attr("src",e)},o=n("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on"),a=null,l=n('<input type="file" />').css({position:"absolute",left:0,top:0,width:"100%",height:"100%",opacity:0,cursor:"pointer"});if(!v&&e.File&&e.FileReader&&e.FileList){var s=function(e){if(e.type.match("image.*")){var t=new FileReader;t.onload=function(t){var n=t.target.result;r(n,e.name)},t.readAsDataURL(e)}};a=l.attr("draggable","true").change(function(e){for(var t=e.target.files,n=0;n<t.length;++n)s(t[n])}).on("dragover",function(e){return e.originalEvent.dataTransfer.dropEffect="copy",e.stopPropagation(),e.preventDefault(),!1}).on("drop",function(e){for(var t=e.originalEvent.dataTransfer.files,n=0;n<t.length;++n)s(t[n]);return e.stopPropagation(),e.preventDefault(),!1})}else if(h){var u=l.change(function(e){h.call(this,r)});a=n("<form/>").append(u)}a&&n("<div/>").addClass("wysiwyg-browse").html(f).append(a).appendTo(o);var p=x(c),y=n('<input type="text" value="" />').addClass("wysiwyg-input").keypress(function(e){(10==e.which||13==e.which)&&r(y.val())});d&&y.attr("placeholder",d);var w=p.click(function(e){return r(y.val()),e.stopPropagation(),e.preventDefault(),!1});return o.append(n("<div/>").append(y).append(w)),o},L=function(e){var t=function(t,r){t=n.trim(t||""),r=n.trim(r||"");var o=!1;t.length&&!r.length?o=t:-1==r.indexOf("<")&&-1==r.indexOf(">")&&r.match(/^(?:https?:\/)?\/?(?:[^:\/\s]+)(?:(?:\/\w+)*\/)(?:[\w\-\.]+[^#?\s]+)(?:.*)?(?:#[\w\-]+)?$/)&&(o=r),o&&y&&(r=y(o)||""),!r.length&&o&&(r='<video src="'+i(o)+'" />'),e.insertHTML(r).closePopup().collapseSelection()},r=n("<div/>").addClass("wysiwyg-toolbar-form").attr("unselectable","on"),o=n("<textarea>").addClass("wysiwyg-input wysiwyg-inputtextarea");p&&o.attr("placeholder",p),n("<div/>").addClass("wysiwyg-embedcode").append(o).appendTo(r);var a=x(c),l=n('<input type="text" value="" />').addClass("wysiwyg-input").keypress(function(e){(10==e.which||13==e.which)&&t(l.val())});d&&l.attr("placeholder",d);var s=a.click(function(e){return t(l.val(),o.val()),e.stopPropagation(),e.preventDefault(),!1});return r.append(n("<div/>").append(l).append(s)),r},R=function(e,t){for(var i=n("<table/>").attr("cellpadding","0").attr("cellspacing","0").attr("unselectable","on"),o=1;15>o;++o){for(var a=n("<tr/>"),l=0;25>l;++l){var s;if(24==l){var u=Math.floor(255/13*(14-o)).toString(16),c=(u.length<2?"0":"")+u;s="#"+c+c+c}else{var f=l/24,d=8>=o?o/8:1,p=o>8?(16-o)/8:1;s=r(f,d,p)}n("<td/>").addClass("wysiwyg-toolbar-color").attr("title",s).attr("unselectable","on").css({backgroundColor:s}).click(function(){var n=this.title;return t?e.forecolor(n).closePopup().collapseSelection():e.highlight(n).closePopup().collapseSelection(),!1}).appendTo(a)}i.append(a)}return i},k=function(e,t){switch(e){case"insertimage":return t?function(e){t(S(j),e)}:null;case"insertvideo":return t?function(e){t(L(j),e)}:null;case"insertlink":return t?function(e){t(E(j),e)}:null;case"bold":return function(){j.bold()};case"italic":return function(){j.italic()};case"underline":return function(){j.underline()};case"strikethrough":return function(){j.strikethrough()};case"forecolor":return t?function(e){t(R(j,!0),e)}:null;case"highlight":return t?function(e){t(R(j,!1),e)}:null;case"alignleft":return function(){j.align("left")};case"aligncenter":return function(){j.align("center")};case"alignright":return function(){j.align("right")};case"alignjustify":return function(){j.align("justify")};case"subscript":return function(){j.subscript()};case"superscript":return function(){j.superscript()};case"indent":return function(){j.indent()};case"outdent":return function(){j.indent(!0)};case"orderedList":return function(){j.insertList(!0)};case"unorderedList":return function(){j.insertList()};case"removeformat":return function(){j.removeFormat().closePopup().collapseSelection()};case"code":var r=n(j.getElement());return o.addClass("wysiwyg-editor"),function(e){var t=n(e),i=r.html(),a=o.val(),l=o.closest(".wysiwyg-container");t.data("isCodeMode")?(l.removeClass("wysiwyg-code-mode"),i!==a&&r.html(o.val()),o.off("focus blur"),o.hide(),r.show().focus(),t.siblings(".wysiwyg-toolbar-icon").trigger("wysiwyg-toolbar-icon-enable")):(l.addClass("wysiwyg-code-mode"),o.height(r.height()).width(r.width()).css("max-width",r.width()).css("min-width",r.width()),o.on("focus",function(){r.triggerHandler("focus")}),o.on("blur",function(){r.triggerHandler("blur")}),r.hide(),l.find(".wysiwyg-placeholder").hide(),o.show().focus(),t.siblings(".wysiwyg-toolbar-icon").trigger("wysiwyg-toolbar-icon-disable")),t.data("isCodeMode",!t.data("isCodeMode"))}}return null},x=function(e){return n("<a/>").addClass("wysiwyg-toolbar-icon "+(e.classes||"")).attr("href","#").attr("title",e.title).attr("unselectable","on").append(e.image).on("wysiwyg-toolbar-icon-disable",function(){n(this).hasClass("wysiwyg-always-enabled")||(e.hotkey&&(A[e.hotkey]=!0),n(this).addClass("wysiwyg-toolbar-icon-disabled"))}).on("wysiwyg-toolbar-icon-enable",function(){n(this).hasClass("wysiwyg-always-enabled")||(e.hotkey&&(A[e.hotkey]=!1),n(this).removeClass("wysiwyg-toolbar-icon-disabled"))}).on("dragstart",function(){return!1})},P=function(e,t,r,i){n.each(u,function(o,a){if(a&&!(t===!1&&"showstatic"in a&&!a.showstatic||t===!0&&"showselection"in a&&!a.showselection)){var l;l="click"in a?function(e){a.click(n(e))}:"popup"in a?function(e){var t=r(),o=a.popup(t,n(e));i(t,e,o)}:k(o,function(e,t){var n=r();n.append(e),i(n,t),n.find("input[type=text]:first").focus()});var s;l?s=x(a).click(function(e){return n(this).hasClass("wysiwyg-toolbar-icon-disabled")||(l(e.currentTarget),k(o)&&j.getElement().focus()),e.stopPropagation(),e.preventDefault(),!1}):a.html&&(s=n(a.html)),s&&e.append(s)}})},M=function(r,i,o,a){for(var l=i.get(0),s=l.offsetParent,u={left:0,top:0},c=!1,f=!1,d=r.width(),p=s;p;){u.left+=p.offsetLeft,u.top+=p.offsetTop;var g=n(p);"fixed"==g.css("position")&&(c=!0),"visible"!=g.css("overflow")&&(f=!0),p=p.offsetParent}var h=n(s||t.body);h.append(r),o+=l.offsetLeft,a+=l.offsetTop,(c||f)&&(o+d>h.width()-1&&(o=h.width()-d-1),1>o&&(o=1));var v=n(e).width();u.left+o+d>v-1&&(o=v-u.left-d-1);var y=c?0:n(e).scrollLeft();u.left+o<y+1&&(o=y-u.left+1),r.css({left:parseInt(o)+"px",top:parseInt(a)+"px"})},I={},A={},N=null,H=function(e,t,r,i){var o=function(e,t,r,i,o,a,l){if(C){var s=N||"";switch(t){case 8:s=s.substring(0,s.length-1);case 13:case 27:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:if(e)return;r=!1;break;default:if(!e)return;s+=r}var c=C(s,t,r,i,o,a,l);if("object"!=typeof c||!c.length)return u.closePopup(),N=null,c;var f=n(u.openPopup());f.hide().addClass("wysiwyg-popup wysiwyg-popuphover").empty().append(c),N=s}},a={element:e.get(0),onKeyDown:function(e,t,n,r,i,a){if(w&&w(e,t,n,r,i,a)===!1)return!1;if(t&&!n&&!r&&i&&!a){var l=t.toLowerCase();if(!I[l]||A[l])return;return I[l](),!1}return o(!1,e,t,n,r,i,a)},onKeyPress:function(e,t,n,r,i,a){return m&&m(e,t,n,r,i,a)===!1?!1:o(!0,e,t,n,r,i,a)},onKeyUp:function(e,t,n,r,i,o){return b&&b(e,t,n,r,i,o)===!1?!1:void 0},onSelection:function(e,t,i,o){var a=!0,l=null;if(e&&n.each(i,function(e,t){return 0!=n(t).parents("a").length?(l=E(u,n(t).parents("a:first")),!1):void 0}),u.readOnly()?a=!1:t?l||o||N||(-1==n.inArray("selection",s.split("-"))?a=!1:e?a=!1:1==i.length&&"IMG"==i[0].nodeName&&(a=!1)):a=!1,!a)return void u.closePopup();var c,f=function(){var e=c.outerWidth(),i=r.offset(),o=n(u.getElement()).offset(),a=t.left+parseInt(t.width/2)-parseInt(e/2)+o.left-i.left,l=t.top+t.height+o.top-i.top;M(c,r,a,l)};c=n(u.openPopup()),c.hasClass("wysiwyg-popuphover")&&!c.data("special")==!l||(c=n(u.closePopup().openPopup())),N?c.show():c.hasClass("wysiwyg-popup")||(c.addClass("wysiwyg-popup wysiwyg-popuphover"),l?c.empty().append(l).data("special",!0):P(c,!0,function(){return c.empty()},f)),f()},onOpenpopup:function(){B()},onClosepopup:function(){N=null,F()},hijackContextmenu:"selection"==s,readOnly:!!e.attr("readonly")};if(i){var l=n("<div/>").addClass("wysiwyg-placeholder").html(i).hide();r.prepend(l),a.onPlaceholder=function(e){e?l.show():l.hide()}}var u=wysiwyg(a);return u},O=n("<div/>").addClass("wysiwyg-container");a&&O.addClass(a),o.wrap(O),O=o.parent(".wysiwyg-container");var D=!1;l&&(D=n("<div/>").addClass("wysiwyg-wrapper").click(function(){j.getElement().focus()}),o.wrap(D),D=o.parent(".wysiwyg-wrapper"));var j=H(o,O,l?D:O,l);if(j.legacy){var o=n(j.getElement());o.addClass("wysiwyg-textarea"),o.is(":visible")&&o.width(O.width()-(o.outerWidth()-o.width()))}else n(j.getElement()).addClass("wysiwyg-editor");var K=null,B=function(){K&&clearTimeout(K),K=null,O.addClass("wysiwyg-active"),O.find(".wysiwyg-toolbar-focus").slideDown()},F=function(){K||t.activeElement==j.getElement()||(K=setTimeout(function(){O.removeClass("wysiwyg-active"),0==n.trim(j.getHTML().replace(/<br\s*[\/]?>/gi,"")).length&&O.find(".wysiwyg-toolbar-focus").slideUp()},100))};n(j.getElement()).focus(B).blur(F);var U={};if(n.each(u,function(e,t){if(t&&t.hotkey){var n=k(e);n&&(I[t.hotkey.toLowerCase()]=n,U[e]=n)}}),!n.isEmptyObject(u)&&"selection"!=s){var W=-1!=n.inArray("top",s.split("-")),X=-1!=n.inArray("focus",s.split("-")),Y=n("<div/>").addClass("wysiwyg-toolbar").addClass(W?"wysiwyg-toolbar-top":"wysiwyg-toolbar-bottom");X&&Y.hide().addClass("wysiwyg-toolbar-focus"),P(Y,!1,function(){var e=n(j.openPopup());return e.hasClass("wysiwyg-popup")&&e.hasClass("wysiwyg-popuphover")&&(e=n(j.closePopup().openPopup())),e.hasClass("wysiwyg-popup")||e.addClass("wysiwyg-popup"),e},function(e,t,r){var i=n(t),o=e.outerWidth(),a=i.offset().left-O.offset().left+parseInt(i.width()/2)-parseInt(o/2),l=i.offset().top-O.offset().top;W?l+=i.outerHeight():l-=e.outerHeight(),r&&(a=r.left,l=r.top),M(e,O,a,l)}),W?O.prepend(Y):O.append(Y)}return{wysiwygeditor:j,$container:O}};n.fn.wysiwyg=function(e,t){if(!e||"object"==typeof e)return e=n.extend({},e),this.each(function(){var t=n(this);if(!t.data("wysiwyg")){var r=e.classes,i=e.placeholder||t.attr("placeholder"),a=e.toolbar||"top",l=e.buttons||{},s=e.submit,u=e.selectImage,c=e.placeholderUrl||null,f=e.placeholderEmbed||null,d=e.maxImageSize||null,p=e.onImageUpload||null,g=e.forceImageUpload&&p,h=e.videoFromUrl||null,v=e.onKeyDown||null,y=e.onKeyPress||null,w=e.onKeyUp||null,m=e.onAutocomplete||null,b=o(t,r,i,a,l,s,u,c,f,d,p,g,h,v,y,w,m);t.data("wysiwyg",b)}});if(1==this.length){var r=this.data("wysiwyg");if(!r)return this;if("container"==e)return r.$container;if("shell"==e)return r.wysiwygeditor}return this}});
